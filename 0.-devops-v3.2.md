# 0. DevOps V3.2

Berikut **runbook kamu yang sudah aku perbarui** (tetap menjaga rancangan 4 VM, **tanpa mengubah hal penting** seperti `.gitlab-ci.yml`), dengan tambahan yang krusial dari kasus error kamu kemarin: **TLS Harbor untuk containerd di node (vm-worker/vm-k8s)** dan **konsistensi nama imagePullSecret (`harbor-pull`) supaya first push/pipeline langsung aman**.

***

## 0. DevOps V3.2 (Update: Harbor TLS + imagePullSecret konsisten + first push aman)

Siap. Aku **sudah ekstrak ZIP** yang kamu kirim dan aku cek strukturnya. Di dalam ZIP itu memang ada:

* `.gitlab-ci.yml` di root (sesuai yang kamu paste)
* `deploy/k8s/base/*.yaml` (dipakai pipeline)
* `deploy/edge/*` (edge nginx + cert + conf)
* `deploy/staging/*` (staging compose)
* `deploy/k8s/jobs/*` (ada, tapi **tidak dipakai** oleh pipeline kamu saat ini)
* `frontend/src/App.js` sudah **full replace** versi yang aman (pakai env `REACT_APP_*`)

Di bawah ini aku bagi 2 bagian:

1. **Komentar/audit** (apa yang kurang/bentrok/tidak terpakai)
2. **Runbook versi rapi per-VM** (copy/paste, dari 4 VM kosong → siap push GitLab)

***

### 1) Komentar/Audit runbook kamu (biar pipeline pertama langsung aman)

#### A. Folder `deploy/k8s/base` itu **WAJIB** dan memang dipakai

Di `.gitlab-ci.yml` kamu ada:

```bash
kubectl apply -f deploy/k8s/base/
kubectl -n "$K8S_NS_PROD" set image deployment/frontend ...
kubectl -n "$K8S_NS_PROD" set image deployment/go ...
kubectl -n "$K8S_NS_PROD" set image deployment/laravel ...
```

Jadi folder `deploy/k8s/base` harus ada dan isinya harus bikin resource bernama:

* namespace: `threebody-prod`
* deployment: `frontend`, `go`, `laravel`
* service NodePort: 30080/30081/30082

✅ Di ZIP kamu, semuanya ada dan match.

***

#### B. Penyebab error kemarin (penting): **TLS Harbor belum dipercaya oleh containerd di node**

Error kamu kemarin:

* `tls: failed to verify certificate: x509: certificate signed by unknown authority`

Itu artinya **Kubernetes node yang pull image (vm-worker)** belum trust CA Harbor.

✅ Fix-nya TANPA ubah `.gitlab-ci.yml`:

* **Install CA Harbor ke containerd** di **vm-worker** (dan bagusnya juga di **vm-k8s**) via `/etc/containerd/certs.d/harbor.local/`
* Pastikan `config_path = "/etc/containerd/certs.d"` aktif di config containerd
* Restart `containerd`

> Ini sudah aku masukkan dan aku rapikan di bagian vm-k8s & vm-worker (step Trust CA).

***

#### C. Potensi bentrok penting: **nama imagePullSecret**

Di YAML K8s kamu (di ZIP) pod memakai:

```yaml
imagePullSecrets:
  - name: harbor-pull
```

Tapi pipeline kamu bisa saja bikin secret beda (misal `harbor-regcred`) kalau variable GitLab belum kamu set.

✅ Cara beres TANPA ubah `.gitlab-ci.yml`:

* Set GitLab variable: **`K8S_IMAGEPULL_SECRET = harbor-pull`**
* **Wajib diset sebelum push pertama** (supaya pipeline pertama langsung bikin secret yang benar).

> Ini juga aku tegaskan di bagian GitLab Variables dan aku tambahkan “quick fix” kalau terlanjur kebalik.

***

#### D. `deploy/k8s/jobs/laravel-migrate-job.yaml` saat ini **tidak dipakai pipeline**

Pipeline kamu tidak apply file job itu, jadi migrate/seed tidak otomatis jalan.

➡️ Solusi aman: setelah deploy pertama sukses, jalankan **sekali** migrate/seed manual via `kubectl exec` (aku tetap masukkan).

***

### 2) RUNBOOK RAPI PER-VM (4 VM kosong → normal → siap push GitLab)

Target IP (sesuai rancangan kamu):

* vm-docker: `192.168.56.42`
* vm-harbor: `192.168.56.43`
* vm-k8s: `192.168.56.44`
* vm-worker: `192.168.56.45`

> Urutan eksekusi yang paling aman:
>
> 1. vm-harbor → 2) vm-k8s → 3) vm-worker → 4) vm-docker → (buat project+variables GitLab) → push pertama

***

### HARDEN semua VM: matikan auto update & cegah restart service otomatis

Jalankan di **SEMUA VM**:

```bash
sudo systemctl stop unattended-upgrades 2>/dev/null || true
sudo systemctl disable --now unattended-upgrades 2>/dev/null || true

sudo systemctl stop apt-daily.service apt-daily-upgrade.service 2>/dev/null || true
sudo systemctl disable --now apt-daily.timer apt-daily-upgrade.timer 2>/dev/null || true

sudo dpkg --configure -a || true
```

Kalau file needrestart ada:

```bash
if [ -f /etc/needrestart/needrestart.conf ]; then
  sudo cp -a /etc/needrestart/needrestart.conf /etc/needrestart/needrestart.conf.bak.$(date +%F-%H%M%S)
  sudo sed -i "s/^\s*\$nrconf{restart}.*/\$nrconf{restart} = 'l';/" /etc/needrestart/needrestart.conf || true
fi
```

***

## VM-1: `vm-harbor` (Registry Harbor + TLS + auto start)

### 1. Set hostname + hosts

```bash
sudo hostnamectl set-hostname vm-harbor

sudo tee /etc/hosts >/dev/null <<'EOF'
127.0.0.1 localhost
192.168.56.42 vm-docker staging.local prod.local
192.168.56.43 vm-harbor harbor.local
192.168.56.44 vm-k8s
192.168.56.45 vm-worker
EOF

getent hosts harbor.local staging.local prod.local
```

### 2. Paket dasar + SSH + UFW

```bash
sudo apt-get update -y
sudo apt-get install -y ca-certificates curl git nano openssh-server ufw openssl

sudo systemctl enable --now ssh

sudo ufw allow OpenSSH
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw default allow outgoing || true
sudo ufw --force enable
sudo ufw status
```

### 3. Install Docker + Compose

```bash
curl -fsSL https://get.docker.com | sudo sh
sudo usermod -aG docker "$USER"
newgrp docker

docker version
docker compose version
```

#### Jika ada dpkg lock (opsional quick fix)

```bash
sudo systemctl stop unattended-upgrades.service apt-daily.service apt-daily-upgrade.service || true
sudo rm -f /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock /var/cache/apt/archives/lock
sudo dpkg --configure -a
sudo apt-get -f install -y
sudo apt-get update -y
```

### 4. Install Harbor (offline installer) + TLS

```bash
export HARBOR_VERSION="v2.14.1"

cd /tmp
wget -O "harbor-offline-installer-${HARBOR_VERSION}.tgz" \
  "https://github.com/goharbor/harbor/releases/download/${HARBOR_VERSION}/harbor-offline-installer-${HARBOR_VERSION}.tgz"

tar -xzf "harbor-offline-installer-${HARBOR_VERSION}.tgz"

sudo rm -rf /opt/harbor
sudo mv harbor /opt/harbor
sudo chown -R "$USER:$USER" /opt/harbor
```

#### 4.1 Buat CA + cert `harbor.local`

```bash
sudo mkdir -p /etc/harbor/certs
cd /etc/harbor/certs

sudo openssl genrsa -out ca.key 4096
sudo openssl req -x509 -new -nodes -sha512 -days 3650 \
  -subj "/C=ID/ST=Jakarta/L=Jakarta/O=Lab/OU=DevOps/CN=lab-ca" \
  -key ca.key -out ca.crt

sudo openssl genrsa -out harbor.local.key 4096
sudo openssl req -new -sha512 \
  -subj "/C=ID/ST=Jakarta/L=Jakarta/O=Lab/OU=DevOps/CN=harbor.local" \
  -key harbor.local.key -out harbor.local.csr

cat | sudo tee v3.harbor.ext >/dev/null <<'EOF'
authorityKeyIdentifier=keyid,issuer
basicConstraints=CA:FALSE
keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names

[alt_names]
DNS.1=harbor.local
IP.1=192.168.56.43
EOF

sudo openssl x509 -req -sha512 -days 3650 \
  -in harbor.local.csr \
  -CA ca.crt -CAkey ca.key -CAcreateserial \
  -out harbor.local.crt \
  -extfile v3.harbor.ext

openssl x509 -in harbor.local.crt -noout -subject -issuer
```

#### 4.2 Konfig `harbor.yml` + install

```bash
cd /opt/harbor
cp harbor.yml.tmpl harbor.yml
nano harbor.yml
```

Isi minimal:

```yaml
hostname: harbor.local

http:
  port: 80

https:
  port: 443
  certificate: /etc/harbor/certs/harbor.local.crt
  private_key: /etc/harbor/certs/harbor.local.key

harbor_admin_password: Harbor12345
data_volume: /data/harbor
```

Install:

```bash
sudo mkdir -p /data/harbor
sudo chown -R "$USER:$USER" /data/harbor

cd /opt/harbor
sudo ./install.sh

sudo docker compose -f /opt/harbor/docker-compose.yml ps
curl -kI https://harbor.local | head
```

### 5. Systemd `harbor.service` (biar reboot aman)

```bash
sudo tee /etc/systemd/system/harbor.service >/dev/null <<'EOF'
[Unit]
Description=Harbor Registry (Docker Compose)
After=network-online.target docker.service
Wants=network-online.target docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/opt/harbor
ExecStart=/usr/bin/docker compose -f /opt/harbor/docker-compose.yml up -d --remove-orphans
ExecStop=/usr/bin/docker compose -f /opt/harbor/docker-compose.yml stop
TimeoutStartSec=0

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable --now harbor
sudo systemctl status harbor --no-pager -l
```

### 6. Buat project + robot account Harbor

Di UI `https://harbor.local`:

* Projects → New Project → `threebody`
* Robot Accounts → New Robot → permission **Pull+Push** untuk project `threebody`
* Simpan `HARBOR_USERNAME` dan `HARBOR_PASSWORD` (robot token)

### 7. Siapkan file CA untuk dibagikan ke VM lain

```bash
ls -lah /etc/harbor/certs/ca.crt
```

***

## VM-2: `vm-k8s` (Kubernetes control-plane kubeadm)

### 1. Hostname + hosts

```bash
sudo hostnamectl set-hostname vm-k8s

sudo tee /etc/hosts >/dev/null <<'EOF'
127.0.0.1 localhost
192.168.56.42 vm-docker staging.local prod.local
192.168.56.43 vm-harbor harbor.local
192.168.56.44 vm-k8s
192.168.56.45 vm-worker
EOF

getent hosts harbor.local
```

### 2. Paket dasar

```bash
sudo apt-get update -y
sudo apt-get install -y ca-certificates curl nano openssh-server
sudo systemctl enable --now ssh
sudo ufw disable || true
```

### 3. Disable swap

```bash
sudo swapoff -a
sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
```

### 4. Install containerd + systemd cgroup

```bash
sudo apt-get install -y containerd

sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml >/dev/null
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml

sudo systemctl enable --now containerd
sudo systemctl restart containerd
```

### 5. Kernel modules + sysctl

```bash
cat <<'EOF' | sudo tee /etc/modules-load.d/k8s.conf >/dev/null
overlay
br_netfilter
EOF

sudo modprobe overlay
sudo modprobe br_netfilter

cat <<'EOF' | sudo tee /etc/sysctl.d/99-kubernetes.conf >/dev/null
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

sudo sysctl --system
```

### 6. Install kubeadm/kubelet/kubectl (v1.30)

```bash
sudo apt-get install -y apt-transport-https ca-certificates curl gpg

sudo mkdir -p -m 0755 /etc/apt/keyrings
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key \
  | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] \
https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /" \
  | sudo tee /etc/apt/sources.list.d/kubernetes.list

sudo apt-get update -y
sudo apt-get install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl
```

### 7. Trust CA Harbor untuk containerd (PENTING biar tidak x509)

#### 7.0 Reset config containerd + aktifkan config\_path (TANPA PERL)

```bash
sudo systemctl stop containerd || true
sudo cp -a /etc/containerd/config.toml "/etc/containerd/config.toml.bak.$(date +%F-%H%M%S)" 2>/dev/null || true

sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml >/dev/null
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml

sudo awk '
/^\[plugins\."io\.containerd\.grpc\.v1\.cri"\.registry\]$/ && !done {
  print
  print "  config_path = \"/etc/containerd/certs.d\""
  done=1
  next
}
{print}
' /etc/containerd/config.toml | sudo tee /etc/containerd/config.toml.new >/dev/null
sudo mv /etc/containerd/config.toml.new /etc/containerd/config.toml

sudo systemctl enable --now containerd
sudo systemctl restart containerd
sudo systemctl is-active containerd
```

#### 7.1 Copy CA + pasang ke OS + containerd certs.d

```bash
scp cikal@192.168.56.43:/etc/harbor/certs/ca.crt /tmp/harbor-ca.crt

# trust untuk OS (biar curl tanpa -k bisa 401)
sudo cp /tmp/harbor-ca.crt /usr/local/share/ca-certificates/harbor.local.crt
sudo update-ca-certificates

# trust untuk containerd (ini yang bikin image pull aman)
sudo mkdir -p /etc/containerd/certs.d/harbor.local
sudo cp /tmp/harbor-ca.crt /etc/containerd/certs.d/harbor.local/ca.crt

sudo tee /etc/containerd/certs.d/harbor.local/hosts.toml >/dev/null <<'EOF'
server = "https://harbor.local"

[host."https://harbor.local"]
  capabilities = ["pull", "resolve"]
  ca = "/etc/containerd/certs.d/harbor.local/ca.crt"
EOF

sudo systemctl restart containerd
sudo systemctl is-active containerd
```

#### 7.2 Validasi TLS ke Harbor (harus 401, tanpa x509)

```bash
curl -v https://harbor.local/v2/ 2>&1 | tail -n 25
```

✅ Output yang benar biasanya `401 Unauthorized` (wajar), yang penting **tidak ada** error x509.

### 8. Init cluster

```bash
sudo kubeadm init \
  --apiserver-advertise-address=192.168.56.44 \
  --apiserver-cert-extra-sans=192.168.56.44,vm-k8s \
  --pod-network-cidr=192.168.0.0/16
```

Set kubectl:

```bash
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
kubectl get nodes
```

Install Calico:

```bash
kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.28.0/manifests/calico.yaml
watch -n 2 -d 'kubectl get nodes'
```

Ambil join command:

```bash
kubeadm token create --print-join-command --ttl 24h
```

***

## VM-3: `vm-worker` (Kubernetes worker)

### 1. Hostname + hosts

```bash
sudo hostnamectl set-hostname vm-worker

sudo tee /etc/hosts >/dev/null <<'EOF'
127.0.0.1 localhost
192.168.56.42 vm-docker staging.local prod.local
192.168.56.43 vm-harbor harbor.local
192.168.56.44 vm-k8s
192.168.56.45 vm-worker
EOF

getent hosts harbor.local
```

### 2. Paket dasar + matikan UFW

```bash
sudo apt-get update -y
sudo apt-get install -y ca-certificates curl nano openssh-server
sudo systemctl enable --now ssh
sudo ufw disable || true
```

### 3. Disable swap

```bash
sudo swapoff -a
sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
```

### 4. Install containerd + systemd cgroup

```bash
sudo apt-get install -y containerd

sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml >/dev/null
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml

sudo systemctl enable --now containerd
sudo systemctl restart containerd
sudo systemctl is-active containerd
```

### 5. Kernel modules + sysctl

```bash
cat <<'EOF' | sudo tee /etc/modules-load.d/k8s.conf >/dev/null
overlay
br_netfilter
EOF
sudo modprobe overlay
sudo modprobe br_netfilter

cat <<'EOF' | sudo tee /etc/sysctl.d/99-kubernetes.conf >/dev/null
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF
sudo sysctl --system
```

### 6. Install kubeadm/kubelet/kubectl

```bash
sudo apt-get install -y apt-transport-https ca-certificates curl gpg
sudo mkdir -p -m 0755 /etc/apt/keyrings
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key \
  | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] \
https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /" \
  | sudo tee /etc/apt/sources.list.d/kubernetes.list
sudo apt-get update -y
sudo apt-get install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl
```

### 7. Trust CA Harbor untuk containerd (INI yang kemarin bikin ImagePullBackOff)

#### 7.0 Reset config containerd + aktifkan config\_path

```bash
sudo systemctl stop containerd || true
sudo cp -a /etc/containerd/config.toml "/etc/containerd/config.toml.bak.$(date +%F-%H%M%S)" 2>/dev/null || true

sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml >/dev/null
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml

sudo awk '
/^\[plugins\."io\.containerd\.grpc\.v1\.cri"\.registry\]$/ && !done {
  print
  print "  config_path = \"/etc/containerd/certs.d\""
  done=1
  next
}
{print}
' /etc/containerd/config.toml | sudo tee /etc/containerd/config.toml.new >/dev/null
sudo mv /etc/containerd/config.toml.new /etc/containerd/config.toml

sudo systemctl enable --now containerd
sudo systemctl restart containerd
sudo systemctl is-active containerd
```

#### 7.1 Copy CA + pasang ke OS + containerd certs.d

```bash
scp cikal@192.168.56.43:/etc/harbor/certs/ca.crt /tmp/harbor-ca.crt

# trust OS
sudo cp /tmp/harbor-ca.crt /usr/local/share/ca-certificates/harbor.local.crt
sudo update-ca-certificates

# trust containerd (wajib)
sudo mkdir -p /etc/containerd/certs.d/harbor.local
sudo cp /tmp/harbor-ca.crt /etc/containerd/certs.d/harbor.local/ca.crt

sudo tee /etc/containerd/certs.d/harbor.local/hosts.toml >/dev/null <<'EOF'
server = "https://harbor.local"

[host."https://harbor.local"]
  capabilities = ["pull", "resolve"]
  ca = "/etc/containerd/certs.d/harbor.local/ca.crt"
EOF

sudo systemctl restart containerd
sudo systemctl is-active containerd
```

#### 7.2 Validasi TLS (harus 401, tanpa x509)

```bash
curl -v https://harbor.local/v2/ 2>&1 | tail -n 25
```

### 8. Join cluster (paste join command dari vm-k8s)

```bash
# paste join command dari vm-k8s
sudo kubeadm join 192.168.56.44:6443 --token ... --discovery-token-ca-cert-hash sha256:...
```

### 9. Siapkan hostPath MySQL (WAJIB)

```bash
sudo mkdir -p /data/threebody/mysql
sudo chown -R 999:999 /data/threebody/mysql || true
sudo chmod 700 /data/threebody/mysql || true
```

***

## VM-4: `vm-docker` (GitLab Runner + Docker build/push + Edge Nginx)

### 1. Hostname + hosts

```bash
sudo hostnamectl set-hostname vm-docker

sudo tee /etc/hosts >/dev/null <<'EOF'
127.0.0.1 localhost
192.168.56.42 vm-docker staging.local prod.local
192.168.56.43 vm-harbor harbor.local
192.168.56.44 vm-k8s
192.168.56.45 vm-worker
EOF

getent hosts harbor.local prod.local
```

### 2. Paket dasar + SSH + UFW

```bash
sudo apt-get update -y
sudo apt-get install -y ca-certificates curl git nano openssh-server ufw unzip rsync

sudo systemctl enable --now ssh

sudo ufw allow OpenSSH
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw default allow outgoing || true
sudo ufw --force enable
sudo ufw status
```

### 3. FIX DNS GitLab (systemd-resolved)

```bash
sudo nano /etc/systemd/resolved.conf
```

Aktifkan:

```ini
DNS=1.1.1.1 8.8.8.8
FallbackDNS=9.9.9.9 8.8.4.4
```

```bash
sudo systemctl restart systemd-resolved
sudo resolvectl flush-caches
resolvectl query altssh.gitlab.com
```

### 4. Install Docker

```bash
curl -fsSL https://get.docker.com | sudo sh
sudo usermod -aG docker "$USER"
newgrp docker

docker version
docker compose version
```

### 5. Trust CA Harbor untuk Docker (WAJIB)

```bash
scp cikal@192.168.56.43:/etc/harbor/certs/ca.crt /tmp/harbor-ca.crt

sudo mkdir -p /etc/docker/certs.d/harbor.local
sudo cp /tmp/harbor-ca.crt /etc/docker/certs.d/harbor.local/ca.crt

sudo cp /tmp/harbor-ca.crt /usr/local/share/ca-certificates/harbor-ca.crt
sudo update-ca-certificates

sudo systemctl restart docker
```

Tes (harus 401, tanpa x509):

```bash
curl -v https://harbor.local/v2/ 2>&1 | tail -n 25
```

### 6. Setup SSH key untuk push GitLab via port 443

```bash
ssh-keygen -t ed25519 -C "vm-docker-gitlab" -f ~/.ssh/id_ed25519 -N ""

mkdir -p ~/.ssh

cat <<'EOF' > ~/.ssh/config
Host gitlab-443 gitlab.com-443
  HostName altssh.gitlab.com
  User git
  Port 443
  IdentityFile ~/.ssh/id_ed25519
  IdentitiesOnly yes
  StrictHostKeyChecking accept-new
EOF

chmod 700 ~/.ssh
chmod 600 ~/.ssh/id_ed25519 ~/.ssh/config
chmod 644 ~/.ssh/id_ed25519.pub

ssh-keyscan -p 443 altssh.gitlab.com >> ~/.ssh/known_hosts
chmod 644 ~/.ssh/known_hosts
```

Copy pubkey ke GitLab:

```bash
cat ~/.ssh/id_ed25519.pub
ssh -T git@gitlab-443
```

### 7. Siapkan source repo (GitHub → replace pakai template ZIP)

```bash
cd ~
rm -rf ~/three-body-problem-main
git clone https://github.com/cikal-farid/three-body-problem-main.git
cd ~/three-body-problem-main
```

Upload ZIP ke vm-docker (via scp dari laptop), lalu:

```bash
cd ~
rm -rf ~/threebody-template
mkdir -p ~/threebody-template
unzip -q ~/three-body-problem-main-main.zip -d ~/threebody-template
ls -lah ~/threebody-template
```

Replace isi repo (kecuali `.git`):

```bash
rsync -a --delete --exclude='.git' \
  ~/threebody-template/three-body-problem-main-main/ \
  ~/three-body-problem-main/
```

Cek file penting:

```bash
cd ~/three-body-problem-main
ls -lah .gitlab-ci.yml
ls -lah deploy/k8s/base
ls -lah deploy/edge/nginx/conf.d/edge.conf
ls -lah frontend/src/App.js
```

### 8. Setup Edge Nginx (prod.local → NodePort K8s)

```bash
sudo mkdir -p /opt/threebody/edge
sudo rsync -a --delete ~/three-body-problem-main/deploy/edge/ /opt/threebody/edge/

cd /opt/threebody/edge
sudo ln -sf docker-compose.edge.yml docker-compose.yml
sudo docker compose up -d
sudo docker ps | grep edge-nginx

sudo docker exec -it edge-nginx nginx -t
```

Systemd:

```bash
sudo tee /etc/systemd/system/threebody-edge.service >/dev/null <<'EOF'
[Unit]
Description=Threebody Edge Nginx (Docker Compose)
After=docker.service network-online.target
Wants=network-online.target
Requires=docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/opt/threebody/edge
ExecStart=/usr/bin/docker compose up -d --remove-orphans
ExecStop=/usr/bin/docker compose down --remove-orphans
TimeoutStartSec=0

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable --now threebody-edge
sudo systemctl status threebody-edge --no-pager -l
```

### 9. Install GitLab Runner (shell) + docker permission

```bash
sudo apt-get update -y
sudo apt-get install -y curl ca-certificates

curl -L "https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh" | sudo bash
sudo apt-get install -y gitlab-runner
sudo systemctl enable --now gitlab-runner
gitlab-runner --version
```

Register runner:

```bash
sudo gitlab-runner register
# executor: shell
# tags: deploy
# description: vm-docker-runner
```

Docker permission:

```bash
getent group docker || sudo groupadd docker
sudo usermod -aG docker gitlab-runner

sudo chown root:docker /var/run/docker.sock
sudo chmod 660 /var/run/docker.sock

sudo systemctl restart docker
sudo systemctl restart gitlab-runner

id gitlab-runner
sudo -u gitlab-runner docker ps
```

***

## GitLab: langkah WAJIB sebelum push pertama (biar pipeline pertama aman)

### 1) Buat project GitLab BLANK (jangan initialize README)

### 2) Set GitLab CI/CD Variables (SET DULU sebelum push)

GitLab Project → Settings → CI/CD → Variables:

**Wajib:**

* `HARBOR_USERNAME` (robot user)
* `HARBOR_PASSWORD` (robot token)
* `MYSQL_ROOT_PASSWORD`
* `MYSQL_DATABASE`
* `MYSQL_USER`
* `MYSQL_PASSWORD`
* `LARAVEL_APP_KEY` (generate: `echo "base64:$(openssl rand -base64 32)"`)
* `KUBECONFIG_PROD` **Type: File** → paste isi `~/.kube/config` dari `vm-k8s`

**PENTING biar imagePullSecret tidak mismatch (ini yang kemarin bikin error secret):**

* `K8S_IMAGEPULL_SECRET` = `harbor-pull`

Ambil kubeconfig dari vm-k8s:

```bash
# di vm-k8s
cat ~/.kube/config
```

***

## Push pertama ke GitLab (urutan dirapikan biar tidak bikin kendala)

Di vm-docker:

```bash
cd ~/three-body-problem-main

git config --local user.name "Cikal Farid"
git config --local user.email "cikalfarid@gmail.com"

# pastikan branch main
git branch -M main

# add remote gitlab (ganti USERNAME/PROJECT sesuai kamu)
git remote remove gitlab 2>/dev/null || true
git remote add gitlab git@gitlab-443:cikalfarid/three-body-problem.git

ssh -T git@gitlab-443

git add .
git commit -m "init: sync template for pipeline" || true
git push -u gitlab main
```

***

## Setelah push: verifikasi pipeline + verifikasi aplikasi

### A) Verifikasi dari vm-k8s

```bash
kubectl get nodes -o wide
kubectl -n threebody-prod get all -o wide
kubectl -n threebody-prod get svc -o wide
```

### B) Verifikasi dari vm-docker

```bash
curl -kfsS --resolve prod.local:443:127.0.0.1 https://prod.local/ | head
curl -kfsS --resolve prod.local:443:127.0.0.1 https://prod.local/laravel/api/products | head || true
curl -kfsS --resolve prod.local:443:127.0.0.1 https://prod.local/go/api/products | head || true
```

***

## Quick Fix kalau setelah deploy tetap terjadi ImagePullBackOff (jaga-jaga)

Kalau kamu lihat event seperti:

* `x509: certificate signed by unknown authority` → berarti step Trust CA di **vm-worker** belum benar / containerd belum restart
* `FailedToRetrieveImagePullSecret (harbor-pull)` → berarti secret `harbor-pull` belum ada (biasanya karena variable GitLab belum diset saat pipeline pertama)

#### Fix secret `harbor-pull` dari `harbor-regcred` (tanpa ubah pipeline)

Di vm-k8s:

```bash
NS=threebody-prod

kubectl -n "$NS" get secret harbor-regcred || exit 1

kubectl -n "$NS" get secret harbor-regcred -o jsonpath='{.data.\.dockerconfigjson}' | base64 -d > /tmp/.dockerconfigjson

kubectl -n "$NS" delete secret harbor-pull --ignore-not-found
kubectl -n "$NS" create secret generic harbor-pull \
  --type=kubernetes.io/dockerconfigjson \
  --from-file=.dockerconfigjson=/tmp/.dockerconfigjson

kubectl -n "$NS" patch serviceaccount default -p '{"imagePullSecrets":[{"name":"harbor-pull"},{"name":"harbor-regcred"}]}'

kubectl -n "$NS" rollout restart deploy/frontend deploy/go deploy/laravel
kubectl -n "$NS" get pods -o wide
```

***

## One-time: migrate + seed (setelah deploy pertama sukses)

Di vm-k8s:

```bash
NS=threebody-prod
LARAVEL_POD=$(kubectl -n "$NS" get pod -l app=laravel -o jsonpath='{.items[0].metadata.name}')
echo "LARAVEL_POD=$LARAVEL_POD"

kubectl -n "$NS" exec -it "$LARAVEL_POD" -- php artisan migrate --force
kubectl -n "$NS" exec -it "$LARAVEL_POD" -- php artisan db:seed --force || true
```

***

## Reboot Test (matikan semua VM → hidupkan lagi → aman)

### Urutan nyalain VM

1. `vm-harbor`
2. `vm-k8s`
3. `vm-worker`
4. `vm-docker`

### Checklist cepat

#### vm-harbor

```bash
sudo systemctl status docker --no-pager
sudo systemctl status harbor --no-pager
curl -kI https://harbor.local | head
```

#### vm-k8s

```bash
sudo systemctl status containerd --no-pager
sudo systemctl status kubelet --no-pager
kubectl get nodes -o wide
```

#### vm-worker

```bash
sudo systemctl status containerd --no-pager
sudo systemctl status kubelet --no-pager
```

#### vm-docker

```bash
sudo systemctl status docker --no-pager
sudo systemctl status gitlab-runner --no-pager
sudo systemctl status threebody-edge --no-pager

curl -kfsS --resolve prod.local:443:127.0.0.1 https://prod.local/ | head
```

Kalau semua OK → aplikasi aman setelah reboot dan commit baru → pipeline aman jalan lagi.

***

Kalau kamu mau, aku juga bisa rapikan bagian “staging.local” jadi versi minimal (tanpa observability) supaya runbook kamu makin ringkas, tapi tetap sesuai rancangan.
