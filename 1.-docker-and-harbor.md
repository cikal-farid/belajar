# 1. Docker and Harbor

Berikut **runbook step-by-step (lengkap)** untuk **fase 1: Docker (VM 192.168.56.42) + Harbor (VM 192.168.56.43)**. Setelah ini baru lanjut fase CI/CD GitLab → Kubernetes → observability/logging, dll.

Acuan port aplikasi dari repo:

* **Laravel API**: `8001`
* **Go API**: `8080`
* **React Frontend**: `3000` ([GitHub](https://github.com/cikal-farid/three-body-problem-main))

***

### 0) Topologi & asumsi minimum

**VM Docker (app host)**

* Nama: `docker`
* IP host-only: `192.168.56.42`
* NIC: NAT + Host-only
* RAM: 2GB

**VM Harbor (registry)**

* Nama: `harbor`
* IP host-only: `192.168.56.43`
* NIC: NAT + Host-only
* RAM: 2GB (ini mepet untuk Harbor; normalnya minimal lebih besar, jadi kita wajib pakai swap) ([Harbor](https://goharbor.io/docs/1.10/install-config/installation-prereqs/?utm_source=chatgpt.com))

Saya pakai hostname registry: **`harbor.local`** (biar enak untuk TLS & docker login).

***

### 1) Baseline OS (jalankan di KEDUA VM)

#### 1.1 Set hostname

**Di VM Docker**

```bash
sudo hostnamectl set-hostname docker
```

**Di VM Harbor**

```bash
sudo hostnamectl set-hostname harbor
```

#### 1.2 Mapping host-only antar VM

**Di KEDUA VM** edit `/etc/hosts`:

```bash
sudo nano /etc/hosts
```

Tambahkan:

```txt
192.168.56.42 docker.local docker
192.168.56.43 harbor.local harbor
```

Cek:

```bash
getent hosts harbor.local
ping -c 2 harbor.local
```

#### 1.3 Update paket + tools dasar

```bash
sudo apt update
sudo apt -y upgrade
sudo apt -y install ca-certificates curl gnupg lsb-release git unzip openssl
```

#### 1.4 (WAJIB di RAM 2GB) Buat swap 2–4GB

**Di KEDUA VM (minimal Harbor dulu kalau mau cepat)**:

```bash
sudo fallocate -l 3G /swapfile || sudo dd if=/dev/zero of=/swapfile bs=1M count=3072
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
free -h
```

***

### 2) Instal Docker Engine + Compose plugin (KEDUA VM)

Gunakan cara resmi repo Docker (ringkas):

```bash
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
sudo chmod a+r /etc/apt/keyrings/docker.gpg

echo \
"deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" \
| sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

sudo apt update
sudo apt -y install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

Set user bisa jalanin docker tanpa sudo:

```bash
sudo usermod -aG docker $USER
newgrp docker
docker version
docker compose version
```

***

### 3) Setup Harbor Registry (di VM Harbor `192.168.56.43`)

> Harbor dikonfigurasi via `harbor.yml`, lalu di-_install_ pakai `install.sh`. ([Harbor](https://goharbor.io/docs/1.10/install-config/configure-yml-file/?utm_source=chatgpt.com))

#### 3.1 Download & extract Harbor (offline installer direkomendasikan)

Buat folder:

```bash
sudo mkdir -p /opt/harbor
cd /opt/harbor
```

#### B1) Install downloader tool (kalau belum ada)

```bash
sudo apt update
sudo apt -y install wget curl
```

#### B2) Download file offline installer (681MB)

Saya pakai mirror SourceForge yang jelas nampilin file `harbor-offline-installer-v2.14.1.tgz`. [sourceforge.net+1](https://sourceforge.net/projects/harbor.mirror/files/v2.14.1/)

```bash
cd /opt/harbor
sudo wget -c -O harbor-offline-installer-v2.14.1.tgz \
  "https://sourceforge.net/projects/harbor.mirror/files/v2.14.1/harbor-offline-installer-v2.14.1.tgz/download"
```

Penjelasan:

* `-c` = kalau putus, bisa lanjut (resume)
* `-O ...tgz` = namanya dipaksa rapi (biar gampang)

#### B3) Pastikan file sudah ada dan ukurannya masuk akal

```bash
cd /opt/harbor
ls -lh
```

**Yang kamu harapkan muncul:**

* `harbor-offline-installer-v2.14.1.tgz` ukuran ratusan MB (sekitar 681MB).

Unduh **Harbor offline installer** versi terbaru dari halaman rilis Harbor (pilih yang `harbor-offline-installer-*.tgz`), lalu extract:

```bash
cd /opt/harbor
sudo tar -xzf harbor-offline-installer-v2.14.1.tgz
cd harbor
ls -la
```

> Kalau kamu sudah pernah install di `/opt/harbor` sebelumnya, langkah ini bisa jadi “reinstall clean”.

#### 3.2 Buat sertifikat TLS self-signed untuk `harbor.local`

Buat folder cert:

```bash
sudo mkdir -p /data/certs
cd /data/certs
```

Buat CA dan server cert (SAN = DNS + IP):

```bash
sudo openssl req -x509 -newkey rsa:4096 -sha256 -days 3650 -nodes \
  -keyout ca.key -out ca.crt -subj "/CN=threebody-harbor-CA"

sudo openssl req -newkey rsa:4096 -nodes \
  -keyout harbor.key -out harbor.csr -subj "/CN=harbor.local"

cat | sudo tee harbor.ext >/dev/null <<'EOF'
subjectAltName=DNS:harbor.local,IP:192.168.56.43
extendedKeyUsage=serverAuth
EOF

sudo openssl x509 -req -in harbor.csr -CA ca.crt -CAkey ca.key -CAcreateserial \
  -out harbor.crt -days 825 -sha256 -extfile harbor.ext

ls -la
```

#### 3.3 Konfigurasi `harbor.yml`

Masuk folder installer:

```bash
cd /opt/harbor/harbor
sudo cp harbor.yml.tmpl harbor.yml
sudo nano harbor.yml
```

Set minimal ini:

```yaml
hostname: harbor.local

http:
  port: 80

https:
  port: 443
  certificate: /data/certs/harbor.crt
  private_key: /data/certs/harbor.key

harbor_admin_password: "GantiPasswordAdmin!"
data_volume: /data/harbor
```

> Konsep enable HTTPS & penggunaan cert ada di dokumentasi Harbor. ([Harbor](https://goharbor.io/docs/1.10/install-config/configure-yml-file/?utm_source=chatgpt.com))

**Opsional (biar ringan di RAM 2GB):** matikan Trivy (scanner) jika ada section `trivy:`:

```yaml
trivy:
  enabled: false
```

#### 3.4 Install / (re)install Harbor

```bash
cd /opt/harbor/harbor
sudo docker compose down || true
sudo ./prepare
sudo ./install.sh
docker compose ps
```

Cek portal dari host/VM lain:

```bash
curl -k https://harbor.local/
# atau
curl -k https://192.168.56.43/
```

Login UI:

* URL: `https://harbor.local`
* user: `admin`
* pass: sesuai `harbor_admin_password`

#### 3.5 Buat Project + Robot Account (untuk push image)

Di Harbor UI:

1. **Projects → New Project**
   * Name: `threebody`
   * Visibility: boleh `Public` untuk lab, atau `Private` kalau mau strict.
2. **Robot Accounts → New Robot Account**
   * Name: `gitlab-ci` (atau `docker-vm`)
   * Scope: project `threebody`
   * Permission: minimal `push/pull`

Simpan **username robot** dan **token** (sekali tampil).

***

### 4) Trust CA Harbor di VM Docker (biar `docker login/push` tidak error)

Docker client bisa trust CA dengan taruh `ca.crt` di:\
`/etc/docker/certs.d/<registry-hostname>/ca.crt` ([Docker Documentation](https://docs.docker.com/engine/security/certificates/?utm_source=chatgpt.com))

#### 4.1 Copy CA cert dari Harbor ke VM Docker

Cara cepat pakai `scp` (jalankan dari VM Docker):

```bash
mkdir -p ~/certs
scp cikal@192.168.56.43:/data/certs/ca.crt ~/certs/harbor-ca.crt
```

#### 4.2 Install CA cert ke Docker daemon (VM Docker)

```bash
sudo mkdir -p /etc/docker/certs.d/harbor.local
sudo cp ~/certs/harbor-ca.crt /etc/docker/certs.d/harbor.local/ca.crt
sudo systemctl restart docker
```

Tes:

```bash
docker login harbor.local
# user: robot$...  (atau admin)
# pass: token/password
```

Kalau masih error “unknown authority”, pastikan:

* host `harbor.local` resolve ke `192.168.56.43`
* folder cert benar: `/etc/docker/certs.d/harbor.local/ca.crt`

***

### 5) Build & Run aplikasi via Docker Compose (di VM Docker `192.168.56.42`)

#### 5.1 Clone repo

```bash
cd ~
git clone https://github.com/cikal-farid/three-body-problem-main.git
cd three-body-problem-main
```

#### 5.2 Siapkan env docker compose

Kamu sudah punya `.env.dev.compose.example`, jadi:

```bash
cp .env.dev.compose.example .env.dev.compose
nano .env.dev.compose
```

Isi minimalnya (contoh aman untuk lab):

```env
MYSQL_ROOT_PASSWORD=rootpass
MYSQL_DATABASE=threebody
MYSQL_USER=threebody
MYSQL_PASSWORD=threebodypass
```

#### 5.3 Build + up

Pakai file compose dev kamu:

```bash
docker compose --env-file .env.dev.compose -f docker-compose.dev.yml up -d --build
docker compose -f docker-compose.dev.yml ps
```

#### 5.4 Validasi endpoint (di VM Docker)

```bash
curl -sS http://127.0.0.1:8001/api/products | head
curl -sS http://127.0.0.1:8080/api/products | head
curl -I  http://127.0.0.1:3000
```

Dari laptop/host kamu (via host-only):

* React: `http://192.168.56.42:3000`
* Laravel: `http://192.168.56.42:8001/api/products`
* Go: `http://192.168.56.42:8080/api/products` ([GitHub](https://github.com/cikal-farid/three-body-problem-main))

***

### 6) Tag & Push images ke Harbor (di VM Docker)

#### 6.1 Tentukan tag (contoh: `dev-<shortsha>`)

```bash
TAG=dev-$(git rev-parse --short HEAD)
echo $TAG
```

#### 6.2 Tag image ke Harbor project

Asumsi nama image hasil build compose sudah ada. Lihat dulu:

```bash
docker images | head -n 20
```

Lalu tag (sesuaikan nama image lokal kamu):

```bash
docker tag three-body-problem-main-laravel:latest  harbor.local/threebody/laravel:$TAG
docker tag three-body-problem-main-go:latest       harbor.local/threebody/go:$TAG
docker tag three-body-problem-main-frontend:latest harbor.local/threebody/frontend:$TAG
```

#### 6.3 Push

```bash
docker push harbor.local/threebody/laravel:$TAG
docker push harbor.local/threebody/go:$TAG
docker push harbor.local/threebody/frontend:$TAG
```

Cek di Harbor UI → project `threebody` → **Repositories** (harus muncul 3 repo + tag barunya).

***

### 7) (Opsional) Jalankan stack dari image Harbor (simulasi “nanti CI/CD”)

Tujuannya: compose **tidak build lokal**, tapi **pull dari Harbor**.

1. Ubah `docker-compose.dev.yml`:

* ganti tiap service jadi pakai:
  * `image: harbor.local/threebody/<svc>:$TAG`
  * hilangkan `build:` (atau jadikan optional)

2. Pull & up:

```bash
docker compose --env-file .env.dev.compose -f docker-compose.dev.yml pull
docker compose --env-file .env.dev.compose -f docker-compose.dev.yml up -d
```

***

### 8) Troubleshooting cepat (yang paling sering kejadian)

#### Harbor berat di 2GB

* Pastikan swap aktif (`free -h`)
* Matikan Trivy (scanner)
* Cek container yang makan RAM:

```bash
docker stats
```

#### Error push/pull: `x509: certificate signed by unknown authority`

Ikuti ulang langkah trust CA (bagian 4) sesuai Docker docs tentang certificates. ([Docker Documentation](https://docs.docker.com/engine/security/certificates/?utm_source=chatgpt.com))

#### MySQL “tidak ada data” / seed tidak masuk

Kalau volume MySQL sudah terlanjur berisi state lama, reset:

```bash
docker compose -f docker-compose.dev.yml down
docker volume ls | grep mysql
docker volume rm <nama_volume_mysql>
docker compose --env-file .env.dev.compose -f docker-compose.dev.yml up -d
```

***

### Output yang harus kamu sudah dapat di FASE 1 ini

1. **Harbor hidup** di `https://harbor.local` dan bisa login.
2. **3 image (frontend/go/laravel)** sudah **ter-push ke Harbor**.
3. Aplikasi bisa jalan via docker compose di VM Docker dan endpoint bisa di-`curl`.

***

Kalau kamu sudah sampai sini, next step paling “natural” adalah:

* **Fase 2: GitLab CI build → tag → push ke Harbor (pakai Robot Account + GitLab Variables)**
* baru lanjut **Fase 3: Deploy ke Kubernetes (VM1 nanti sebagai cluster)** + HTTPS + rate limit via Ingress/Nginx, lalu observability (Grafana/Loki/Promtail atau EFK).

Kalau kamu mau, kirimkan isi **`docker-compose.dev.yml`** dan daftar **nama image** dari `docker images` (10 baris atas), biar saya rapikan step **tag/push**-nya supaya 100% match dengan naming kamu.
