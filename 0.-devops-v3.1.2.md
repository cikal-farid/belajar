# 0. DevOps V3.1.2

Sip — aku sudah buka ZIP kamu (`three-body-problem-main-main`) dan aku **lihat langsung** isi `laravel/Dockerfile` yang sekarang. Penyebab utama image Laravel kamu “terasa” besar itu karena base `php:8.2-apache` memang berat, lalu di Dockerfile sekarang kamu **install banyak paket `*-dev`** dan **tidak pernah dipurge** (jadi paket build ikut kebawa ke image final). Itu yang bikin disk usage bisa tembus \~900MB.

Di bawah ini aku kasih 2 hal:

1. **Perbaikan file project** (Dockerfile Laravel lebih kecil + edge hanya `hit.local` + `.gitlab-ci.yml` stage `build/push/deploy` + healthcheck hanya `hit.local`)
2. **Runbook versi “sama modelnya”** seperti yang kamu kirim (HARDEN + ADD-ON + per-VM) tapi **sudah fokus penuh** ke semua kendala yang pernah terjadi dari awal sampai akhir: dpkg lock, DNS, CA/x509 Harbor, containerd `certs.d`, edge-nginx “host not found”, runner docker permission, kube-apiserver 6443 refused, worker NotReady, rollout timeout.

***

## A) PERUBAHAN FILE PROJECT (copy–paste)

### A1) `laravel/Dockerfile` versi lebih kecil (replace isi file yang sekarang)

> Konsepnya: **build PHP extensions sekali**, lalu **purge build deps** (termasuk `$PHPIZE_DEPS`), composer jalan di stage vendor, final image jadi lebih ramping.

```dockerfile
# syntax=docker/dockerfile:1

# Ambil binary composer saja
FROM composer:2 AS composerbin

# =========================
# Base runtime (Apache + PHP)
# - Build ext, lalu buang build deps (biar image lebih kecil)
# =========================
FROM php:8.2-apache AS base
WORKDIR /var/www/html

# Apache docroot -> /public
ENV APACHE_DOCUMENT_ROOT=/var/www/html/public
RUN sed -ri 's!/var/www/html!${APACHE_DOCUMENT_ROOT}!g' /etc/apache2/sites-available/*.conf \
 && sed -ri 's!/var/www/!${APACHE_DOCUMENT_ROOT}!g' /etc/apache2/apache2.conf /etc/apache2/conf-available/*.conf

# Install deps untuk build ext -> build -> purge
RUN set -eux; \
  apt-get update; \
  apt-get install -y --no-install-recommends \
    libzip-dev libicu-dev libonig-dev \
    libpng-dev libjpeg62-turbo-dev libfreetype6-dev \
  ; \
  docker-php-ext-configure gd --with-freetype --with-jpeg; \
  docker-php-ext-install -j"$(nproc)" \
    pdo_mysql mbstring zip intl bcmath exif gd opcache \
  ; \
  a2enmod rewrite headers; \
  \
  # buang build deps (ini yang bikin image kamu jauh lebih kecil)
  apt-get purge -y \
    $PHPIZE_DEPS \
    libzip-dev libicu-dev libonig-dev \
    libpng-dev libjpeg62-turbo-dev libfreetype6-dev \
  ; \
  apt-get clean; \
  rm -rf /var/lib/apt/lists/* /usr/src/php* /tmp/*

# =========================
# Vendor stage: composer install (no-dev)
# =========================
FROM base AS vendor
COPY --from=composerbin /usr/bin/composer /usr/bin/composer

# kebutuhan composer (hanya di stage ini, tidak ikut final)
RUN set -eux; \
  apt-get update; \
  apt-get install -y --no-install-recommends git unzip; \
  rm -rf /var/lib/apt/lists/*

COPY . .

ENV COMPOSER_ALLOW_SUPERUSER=1
RUN composer install \
  --no-dev \
  --prefer-dist \
  --no-interaction \
  --no-progress \
  --optimize-autoloader

# =========================
# Runtime stage
# =========================
FROM base AS runtime
COPY --from=vendor /var/www/html /var/www/html

RUN chown -R www-data:www-data storage bootstrap/cache || true \
 && chmod -R 775 storage bootstrap/cache || true

EXPOSE 80
CMD ["apache2-foreground"]
```

✅ Kamu sudah punya `laravel/.dockerignore` yang bagus (vendor & node\_modules sudah diignore), jadi itu cukup.

***

### A2) `deploy/edge/nginx/conf.d/edge.conf` jadi **hanya hit.local** (hapus staging/prod)

> Ini akan menghilangkan sumber error “host not found in upstream stg-frontend” + kamu nggak akan lihat 502 untuk staging/prod lagi.

Replace file ini:

```nginx
# resolver docker (biar aman kalau suatu saat ada upstream nama container)
resolver 127.0.0.11 ipv6=off valid=10s;

# rate limiting zone
limit_req_zone $binary_remote_addr zone=api_rl:10m rate=5r/s;

server {
  listen 80;
  server_name hit.local;
  return 301 https://$host$request_uri;
}

server {
  listen 443 ssl;
  server_name hit.local;

  ssl_certificate     /etc/nginx/certs/tls.crt;
  ssl_certificate_key /etc/nginx/certs/tls.key;

  location / {
    proxy_pass http://192.168.56.45:30080;
  }

  location /go/ {
    limit_req zone=api_rl burst=10 nodelay;
    proxy_pass http://192.168.56.45:30081/;
  }

  location /laravel/ {
    limit_req zone=api_rl burst=10 nodelay;
    proxy_pass http://192.168.56.45:30082/;
  }
}
```

***

### A3) `.gitlab-ci.yml` stage jadi `build/push/deploy` + healthcheck hanya `hit.local`

Perubahan kunci:

* `stages:` jadi `build, push, deploy`
* `deploy_prod:` jadi `deploy:`
* `K8S_IMAGEPULL_SECRET` default **samakan** dengan manifest kamu: `harbor-pull`
* healthcheck pakai `hit.local`
* kalau rollout gagal, job langsung dump debug (pods/events/describe)

**Replace isi `.gitlab-ci.yml` kamu dengan ini:**

```yaml
stages:
  - build
  - push
  - deploy

workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - when: never

variables:
  DOCKER_BUILDKIT: "1"
  TAG: "$CI_COMMIT_SHORT_SHA"

  HARBOR_HOST: "harbor.local"
  HARBOR_PROJECT: "threebody"
  REGISTRY: "$HARBOR_HOST/$HARBOR_PROJECT"

  K8S_NS: "threebody-prod"
  KUBECTL_VERSION: "v1.30.14"
  K8S_ROLLOUT_TIMEOUT: "15m"
  K8S_IMAGEPULL_SECRET: "harbor-pull"

default:
  tags: ["deploy"]
  before_script:
    - set -euo pipefail

build_check:
  stage: build
  script: |
    echo "==> [build] build-check images (tanpa push)"
    docker build \
      --build-arg REACT_APP_GO_API_BASE=/go \
      --build-arg REACT_APP_LARAVEL_API_BASE=/laravel \
      -t "$REGISTRY/frontend:$TAG" \
      -f frontend/Dockerfile frontend
    docker build -t "$REGISTRY/go:$TAG" -f go/Dockerfile go
    docker build -t "$REGISTRY/laravel:$TAG" -f laravel/Dockerfile laravel

push_images:
  stage: push
  needs: ["build_check"]
  script: |
    echo "==> [push] login Harbor"
    : "${HARBOR_USERNAME:?Missing HARBOR_USERNAME}"
    : "${HARBOR_PASSWORD:?Missing HARBOR_PASSWORD}"
    echo "$HARBOR_PASSWORD" | docker login "$HARBOR_HOST" -u "$HARBOR_USERNAME" --password-stdin

    echo "==> [push] build+push images (TAG=$TAG)"
    docker build \
      --build-arg REACT_APP_GO_API_BASE=/go \
      --build-arg REACT_APP_LARAVEL_API_BASE=/laravel \
      -t "$REGISTRY/frontend:$TAG" \
      -f frontend/Dockerfile frontend
    docker push "$REGISTRY/frontend:$TAG"

    docker build -t "$REGISTRY/go:$TAG" -f go/Dockerfile go
    docker push "$REGISTRY/go:$TAG"

    docker build -t "$REGISTRY/laravel:$TAG" -f laravel/Dockerfile laravel
    docker push "$REGISTRY/laravel:$TAG"

deploy:
  stage: deploy
  needs: ["push_images"]
  script: |
    echo "==> [deploy] validasi variables"
    : "${KUBECONFIG_PROD:?Missing KUBECONFIG_PROD (GitLab Variables Type: File)}"
    : "${HARBOR_USERNAME:?Missing HARBOR_USERNAME}"
    : "${HARBOR_PASSWORD:?Missing HARBOR_PASSWORD}"
    : "${MYSQL_ROOT_PASSWORD:?Missing MYSQL_ROOT_PASSWORD}"
    : "${MYSQL_DATABASE:?Missing MYSQL_DATABASE}"
    : "${MYSQL_USER:?Missing MYSQL_USER}"
    : "${MYSQL_PASSWORD:?Missing MYSQL_PASSWORD}"
    : "${LARAVEL_APP_KEY:?Missing LARAVEL_APP_KEY}"

    echo "==> [deploy] siapkan kubectl"
    mkdir -p .bin
    if [ ! -x .bin/kubectl ]; then
      curl -fsSL -o .bin/kubectl "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
      chmod +x .bin/kubectl
    fi
    export PATH="$PWD/.bin:$PATH"
    export KUBECONFIG="$KUBECONFIG_PROD"
    kubectl version --client=true

    echo "==> [deploy] cek cluster"
    kubectl get nodes -o wide

    echo "==> [deploy] namespace + secrets"
    kubectl get ns "$K8S_NS" >/dev/null 2>&1 || kubectl create ns "$K8S_NS"

    kubectl -n "$K8S_NS" create secret generic app-secrets \
      --from-literal=MYSQL_ROOT_PASSWORD="$MYSQL_ROOT_PASSWORD" \
      --from-literal=MYSQL_DATABASE="$MYSQL_DATABASE" \
      --from-literal=MYSQL_USER="$MYSQL_USER" \
      --from-literal=MYSQL_PASSWORD="$MYSQL_PASSWORD" \
      --from-literal=LARAVEL_APP_KEY="$LARAVEL_APP_KEY" \
      --dry-run=client -o yaml | kubectl apply -f -

    kubectl -n "$K8S_NS" create secret docker-registry "$K8S_IMAGEPULL_SECRET" \
      --docker-server="$HARBOR_HOST" \
      --docker-username="$HARBOR_USERNAME" \
      --docker-password="$HARBOR_PASSWORD" \
      --dry-run=client -o yaml | kubectl apply -f -

    kubectl -n "$K8S_NS" patch serviceaccount default \
      -p "{\"imagePullSecrets\": [{\"name\": \"$K8S_IMAGEPULL_SECRET\"}]}" >/dev/null || true

    echo "==> [deploy] apply manifests"
    kubectl apply -f deploy/k8s/base/

    echo "==> [deploy] update image tag"
    kubectl -n "$K8S_NS" set image deployment/frontend frontend="$REGISTRY/frontend:$TAG"
    kubectl -n "$K8S_NS" set image deployment/go go="$REGISTRY/go:$TAG"
    kubectl -n "$K8S_NS" set image deployment/laravel laravel="$REGISTRY/laravel:$TAG"

    echo "==> [deploy] rollout"
    kubectl -n "$K8S_NS" rollout status deployment/frontend --timeout="$K8S_ROLLOUT_TIMEOUT" || (
      echo "---- DEBUG (frontend rollout gagal) ----"
      kubectl -n "$K8S_NS" get pods -o wide || true
      kubectl -n "$K8S_NS" get endpoints frontend -o wide || true
      kubectl -n "$K8S_NS" describe deploy frontend || true
      kubectl -n "$K8S_NS" get events --sort-by=.lastTimestamp | tail -n 80 || true
      exit 1
    )
    kubectl -n "$K8S_NS" rollout status deployment/go --timeout="$K8S_ROLLOUT_TIMEOUT"
    kubectl -n "$K8S_NS" rollout status deployment/laravel --timeout="$K8S_ROLLOUT_TIMEOUT"

    echo "==> [deploy] healthcheck via edge nginx (hit.local di vm-docker)"
    for i in $(seq 1 60); do
      if curl -kfsS --resolve hit.local:443:127.0.0.1 https://hit.local/ >/dev/null 2>&1; then
        echo "https://harbor.local/"
        echo "https://hit.local/"
        exit 0
      fi
      sleep 2
    done

    echo "ERROR: hit.local healthcheck gagal"
    kubectl -n "$K8S_NS" get pods -o wide || true
    kubectl -n "$K8S_NS" describe pods || true
    exit 1
```

***

## B) RUNBOOK V3.2 FINAL (harbor.local + hit.local only)

> Urutan paling aman untuk VM kosong:\
> **1) vm-harbor → 2) vm-k8s → 3) vm-worker → 4) vm-docker**

IP (tetap):

* vm-docker: `192.168.56.42` (**hit.local**)
* vm-harbor: `192.168.56.43` (**harbor.local**)
* vm-k8s: `192.168.56.44`
* vm-worker: `192.168.56.45`

***

### 0) HARDEN SEMUA VM (wajib, cegah dpkg lock + restart service random)

Jalankan di **SEMUA VM**:

```bash
sudo systemctl stop unattended-upgrades 2>/dev/null || true
sudo systemctl disable --now unattended-upgrades 2>/dev/null || true

sudo systemctl stop apt-daily.service apt-daily-upgrade.service 2>/dev/null || true
sudo systemctl disable --now apt-daily.timer apt-daily-upgrade.timer 2>/dev/null || true

sudo dpkg --configure -a || true

# needrestart jangan auto restart service
if [ -f /etc/needrestart/needrestart.conf ]; then
  sudo cp -a /etc/needrestart/needrestart.conf /etc/needrestart/needrestart.conf.bak.$(date +%F-%H%M%S)
  sudo sed -i "s/^\s*\$nrconf{restart}.*/\$nrconf{restart} = 'l';/" /etc/needrestart/needrestart.conf || true
fi
```

#### ADD-ON: APT LOCK UNIVERSAL FIX (pakai kapan pun apt macet)

```bash
sudo systemctl stop unattended-upgrades apt-daily.service apt-daily-upgrade.service 2>/dev/null || true
sudo rm -f /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock /var/cache/apt/archives/lock
sudo dpkg --configure -a || true
sudo apt-get -f install -y || true
sudo apt-get update -y
```

***

### 1) `/etc/hosts` (wajib, di SEMUA VM)

```bash
sudo tee /etc/hosts >/dev/null <<'EOF'
127.0.0.1 localhost
192.168.56.42 vm-docker hit.local
192.168.56.43 vm-harbor harbor.local
192.168.56.44 vm-k8s
192.168.56.45 vm-worker
EOF

getent hosts harbor.local hit.local
```

***

## VM-1: vm-harbor (Harbor Registry + TLS)

### 1. Install paket dasar + Docker

```bash
sudo apt-get update -y
sudo apt-get install -y ca-certificates curl git nano openssh-server ufw openssl
sudo systemctl enable --now ssh

curl -fsSL https://get.docker.com | sudo sh
sudo usermod -aG docker "$USER"
newgrp docker

docker version
docker compose version
```

### 2. UFW (lab aman)

```bash
sudo ufw allow OpenSSH
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw --force enable
sudo ufw status
```

### 3. Install Harbor + buat CA + cert `harbor.local`

> (pakai versi yang kamu mau, ini contoh tetap)

```bash
export HARBOR_VERSION="v2.14.1"

cd /tmp
wget -O "harbor-offline-installer-${HARBOR_VERSION}.tgz" \
  "https://github.com/goharbor/harbor/releases/download/${HARBOR_VERSION}/harbor-offline-installer-${HARBOR_VERSION}.tgz"

tar -xzf "harbor-offline-installer-${HARBOR_VERSION}.tgz"
sudo rm -rf /opt/harbor
sudo mv harbor /opt/harbor
sudo chown -R "$USER:$USER" /opt/harbor
```

#### Buat CA + cert

```bash
sudo mkdir -p /etc/harbor/certs
cd /etc/harbor/certs

sudo openssl genrsa -out ca.key 4096
sudo openssl req -x509 -new -nodes -sha512 -days 3650 \
  -subj "/C=ID/ST=Jakarta/L=Jakarta/O=Lab/OU=DevOps/CN=lab-ca" \
  -key ca.key -out ca.crt

sudo openssl genrsa -out harbor.local.key 4096
sudo openssl req -new -sha512 \
  -subj "/C=ID/ST=Jakarta/L=Jakarta/O=Lab/OU=DevOps/CN=harbor.local" \
  -key harbor.local.key -out harbor.local.csr

cat | sudo tee v3.harbor.ext >/dev/null <<'EOF'
authorityKeyIdentifier=keyid,issuer
basicConstraints=CA:FALSE
keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names

[alt_names]
DNS.1=harbor.local
IP.1=192.168.56.43
EOF

sudo openssl x509 -req -sha512 -days 3650 \
  -in harbor.local.csr \
  -CA ca.crt -CAkey ca.key -CAcreateserial \
  -out harbor.local.crt \
  -extfile v3.harbor.ext
```

#### Config `harbor.yml` + install

```bash
cd /opt/harbor
cp harbor.yml.tmpl harbor.yml
nano harbor.yml
```

Isi minimal:

```yaml
hostname: harbor.local
http:
  port: 80
https:
  port: 443
  certificate: /etc/harbor/certs/harbor.local.crt
  private_key: /etc/harbor/certs/harbor.local.key
harbor_admin_password: Harbor12345
data_volume: /data/harbor
trivy:
  enabled: false
```

Install:

```bash
sudo mkdir -p /data/harbor
sudo ./install.sh
sudo docker compose -f /opt/harbor/docker-compose.yml ps
```

### 4. Systemd autostart Harbor

```bash
sudo tee /etc/systemd/system/harbor.service >/dev/null <<'EOF'
[Unit]
Description=Harbor Registry (Docker Compose)
After=network-online.target docker.service
Wants=network-online.target docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/opt/harbor
ExecStart=/usr/bin/docker compose -f /opt/harbor/docker-compose.yml up -d --remove-orphans
ExecStop=/usr/bin/docker compose -f /opt/harbor/docker-compose.yml stop
TimeoutStartSec=0

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable --now harbor
```

### 5. Buat project + robot account

Di UI:

* [**https://harbor.local/**](https://harbor.local/)
* Create Project: `threebody`
* Robot account (misal): `gitlab-ci` → simpan token untuk GitLab variable

### 6. Siapkan CA untuk dibagikan

File penting:

```bash
ls -lah /etc/harbor/certs/ca.crt
```

***

## VM-2: vm-k8s (Kubernetes control-plane)

### 1. Paket dasar + disable swap + sysctl + containerd

```bash
sudo apt-get update -y
sudo apt-get install -y ca-certificates curl nano openssh-server
sudo systemctl enable --now ssh

sudo swapoff -a
sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab

cat <<'EOF' | sudo tee /etc/modules-load.d/k8s.conf >/dev/null
overlay
br_netfilter
EOF
sudo modprobe overlay
sudo modprobe br_netfilter

cat <<'EOF' | sudo tee /etc/sysctl.d/99-kubernetes.conf >/dev/null
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF
sudo sysctl --system

sudo apt-get install -y containerd
```

### 2. ADD-ON wajib: reset containerd + set `SystemdCgroup` + `config_path`

```bash
sudo systemctl stop containerd || true
sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml >/dev/null

sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml

sudo awk '
/^\[plugins\."io\.containerd\.grpc\.v1\.cri"\.registry\]$/ && !done {
  print
  print "  config_path = \"/etc/containerd/certs.d\""
  done=1
  next
}
{print}
' /etc/containerd/config.toml | sudo tee /etc/containerd/config.toml.new >/dev/null
sudo mv /etc/containerd/config.toml.new /etc/containerd/config.toml

sudo systemctl enable --now containerd
sudo systemctl restart containerd
sudo systemctl is-active containerd
```

### 3. Trust CA Harbor (x509 fix permanen)

```bash
scp cikal@192.168.56.43:/etc/harbor/certs/ca.crt /tmp/harbor-ca.crt

sudo cp /tmp/harbor-ca.crt /usr/local/share/ca-certificates/harbor.local.crt
sudo update-ca-certificates

sudo mkdir -p /etc/containerd/certs.d/harbor.local
sudo cp /tmp/harbor-ca.crt /etc/containerd/certs.d/harbor.local/ca.crt

sudo tee /etc/containerd/certs.d/harbor.local/hosts.toml >/dev/null <<'EOF'
server = "https://harbor.local"

[host."https://harbor.local"]
  capabilities = ["pull", "resolve"]
  ca = "/etc/containerd/certs.d/harbor.local/ca.crt"
EOF

sudo systemctl restart containerd
```

### 4. Install kubeadm/kubelet/kubectl v1.30

```bash
sudo apt-get install -y apt-transport-https ca-certificates curl gpg
sudo mkdir -p -m 0755 /etc/apt/keyrings
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key \
  | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] \
https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /" \
  | sudo tee /etc/apt/sources.list.d/kubernetes.list

sudo apt-get update -y
sudo apt-get install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl
```

### 5. kubeadm init + Calico

```bash
sudo kubeadm init \
  --apiserver-advertise-address=192.168.56.44 \
  --apiserver-cert-extra-sans=192.168.56.44,vm-k8s \
  --pod-network-cidr=192.168.0.0/16

mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.28.0/manifests/calico.yaml
kubectl get nodes -o wide
```

Ambil join command:

```bash
kubeadm token create --print-join-command --ttl 24h
```

#### ADD-ON penting: cek 6443 refused (kalau suatu saat kejadian lagi)

```bash
sudo ss -lntp | grep 6443 || true
sudo systemctl is-active kubelet containerd
sudo journalctl -u kubelet --no-pager | tail -n 120
dmesg -T | egrep -i "oom|killed process|out of memory" || true
df -h
free -h
```

***

## VM-3: vm-worker (Kubernetes worker)

### 1. Setup sama (swap/sysctl/containerd/kube\*)

Langkahnya **sama** seperti vm-k8s untuk:

* disable swap
* sysctl
* install containerd
* reset containerd (SystemdCgroup + config\_path)
* trust CA harbor (hosts.toml)
* install kubelet/kubeadm/kubectl

> Copy paste dari bagian vm-k8s (bagian 1–4) dan jalankan di vm-worker.

### 2. Join cluster

```bash
sudo kubeadm join 192.168.56.44:6443 --token ... --discovery-token-ca-cert-hash sha256:...
```

### 3. HostPath MySQL (wajib)

```bash
sudo mkdir -p /data/threebody/mysql
sudo chown -R 999:999 /data/threebody/mysql || true
sudo chmod 700 /data/threebody/mysql || true
```

#### ADD-ON: kalau worker “lama Ready / NotReady”

```bash
sudo systemctl is-active containerd kubelet
sudo journalctl -u kubelet --no-pager | tail -n 120
sudo journalctl -u containerd --no-pager | tail -n 120
```

***

## VM-4: vm-docker (GitLab Runner + Docker build/push + Edge hit.local)

### 1. Fix DNS untuk GitLab (biar altssh.gitlab.com resolve stabil)

```bash
sudo tee /etc/systemd/resolved.conf >/dev/null <<'EOF'
[Resolve]
DNS=1.1.1.1 8.8.8.8
FallbackDNS=9.9.9.9 8.8.4.4
DNSStubListener=yes
EOF

sudo systemctl restart systemd-resolved
sudo resolvectl flush-caches

# pakai resolv.conf real (bukan 127.0.0.53)
sudo ln -sf /run/systemd/resolve/resolv.conf /etc/resolv.conf
```

### 2. Install Docker + trust CA Harbor (biar push aman)

```bash
sudo apt-get update -y
sudo apt-get install -y ca-certificates curl git nano openssh-server ufw unzip rsync
sudo systemctl enable --now ssh

curl -fsSL https://get.docker.com | sudo sh
sudo usermod -aG docker "$USER"
newgrp docker

scp cikal@192.168.56.43:/etc/harbor/certs/ca.crt /tmp/harbor-ca.crt
sudo mkdir -p /etc/docker/certs.d/harbor.local
sudo cp /tmp/harbor-ca.crt /etc/docker/certs.d/harbor.local/ca.crt
sudo cp /tmp/harbor-ca.crt /usr/local/share/ca-certificates/harbor-ca.crt
sudo update-ca-certificates
sudo systemctl restart docker
```

### 3. Edge Nginx (hit.local) ke NodePort

```bash
sudo mkdir -p /opt/threebody/edge
sudo rsync -a --delete ~/three-body-problem-main/deploy/edge/ /opt/threebody/edge/

cd /opt/threebody/edge
sudo ln -sf docker-compose.edge.yml docker-compose.yml
sudo docker compose up -d
sudo docker exec -it edge-nginx nginx -t
```

Smoke test:

```bash
curl -kI --resolve hit.local:443:127.0.0.1 https://hit.local/ | head
```

### 4. GitLab Runner (shell) + docker permission

```bash
curl -L "https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh" | sudo bash
sudo apt-get install -y gitlab-runner
sudo systemctl enable --now gitlab-runner

getent group docker || sudo groupadd docker
sudo usermod -aG docker gitlab-runner
sudo chown root:docker /var/run/docker.sock
sudo chmod 660 /var/run/docker.sock
sudo systemctl restart docker
sudo systemctl restart gitlab-runner

sudo -u gitlab-runner docker ps
```

#### ADD-ON: jika job push\_images gagal docker permission

```bash
id gitlab-runner
ls -l /var/run/docker.sock
sudo -u gitlab-runner docker ps || true
```

### 5. SSH GitLab via port 443 (altssh)

```bash
ssh-keygen -t ed25519 -C "vm-docker-gitlab" -f ~/.ssh/id_ed25519 -N ""
mkdir -p ~/.ssh

cat <<'EOF' > ~/.ssh/config
Host gitlab-443
  HostName altssh.gitlab.com
  User git
  Port 443
  IdentityFile ~/.ssh/id_ed25519
  IdentitiesOnly yes
  StrictHostKeyChecking accept-new
EOF

chmod 700 ~/.ssh
chmod 600 ~/.ssh/id_ed25519 ~/.ssh/config
ssh -T git@gitlab-443
```

***

### GitLab Variables (wajib, biar run pertama di VM kosong aman)

Project → Settings → CI/CD → Variables:

* `HARBOR_USERNAME` (robot user)
* `HARBOR_PASSWORD` (robot token)
* `MYSQL_ROOT_PASSWORD`
* `MYSQL_DATABASE`
* `MYSQL_USER`
* `MYSQL_PASSWORD`
* `LARAVEL_APP_KEY` (contoh: `base64:...`)
* `KUBECONFIG_PROD` **Type: File** (isi `~/.kube/config` dari vm-k8s)
* (opsional tapi aman) `K8S_IMAGEPULL_SECRET = harbor-pull` (kalau kamu mau override)

***

### After deploy pertama: migrate/seed (sekali saja)

Di vm-k8s:

```bash
NS=threebody-prod
LARAVEL_POD=$(kubectl -n "$NS" get pod -l app=laravel -o jsonpath='{.items[0].metadata.name}')
kubectl -n "$NS" exec -it "$LARAVEL_POD" -- php artisan migrate --force
kubectl -n "$NS" exec -it "$LARAVEL_POD" -- php artisan db:seed --force || true
```

***

### ADD-ON khusus error kamu: “rollout frontend old replicas pending termination”

Kalau kejadian lagi, jalankan di vm-k8s:

```bash
NS=threebody-prod
kubectl -n "$NS" get pods -o wide
kubectl -n "$NS" get rs -l app=frontend -o wide
kubectl -n "$NS" get events --sort-by=.lastTimestamp | tail -n 80

# cari pod frontend yang stuck Terminating
kubectl -n "$NS" get pod -l app=frontend -o jsonpath='{range .items[*]}{.metadata.name}{"  "}{.metadata.deletionTimestamp}{"\n"}{end}'

# kalau ada yang deletionTimestamp-nya ada dan lama -> force delete
POD=$(kubectl -n "$NS" get pod -l app=frontend -o jsonpath='{.items[0].metadata.name}')
kubectl -n "$NS" delete pod "$POD" --force --grace-period=0
```

***

## OUTPUT URL (sesuai permintaanmu)

[https://harbor.local/](https://harbor.local/)\
[https://hit.local/](https://hit.local/)
